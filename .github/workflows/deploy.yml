name: Deploy Astro site

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout the branch being pushed
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️⃣ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 3️⃣ Build site
      - name: Build site
        run: |
          if [ "${GITHUB_REF##*/}" = "dev" ]; then
            npm run build:dev   # base already set to /dev/
          else
            npm run build      # production build for main
          fi

      # 4️⃣ Checkout gh-pages branch
      - name: Checkout gh-pages
        run: |
          git fetch origin gh-pages
          git checkout gh-pages || git checkout --orphan gh-pages

      # 5️⃣ Copy build into correct folder
      - name: Copy build
        run: |
          if [ "${GITHUB_REF##*/}" = "dev" ]; then
            mkdir -p dev
            rm -rf dev/*
            cp -r dist/* dev/
          else
            rm -rf *
            cp -r dist/* .
          fi

      # 6️⃣ Commit changes
      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Deploy ${GITHUB_REF##*/} build from $GITHUB_SHA" || echo "No changes to commit"

      # 7️⃣ Push to gh-pages
      - name: Push to gh-pages
        run: git push origin gh-pages
